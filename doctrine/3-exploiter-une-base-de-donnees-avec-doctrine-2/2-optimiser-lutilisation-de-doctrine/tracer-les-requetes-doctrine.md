
Avant d'aborder les méthodes d'optimisation, nous allons configurer la connexion afin de tracer toutes les requêtes exécutées. Ainsi, nous pourrons voir en détail les résultats des optimisations que nous effectuerons.
Pour ce faire, il suffit de créer une classe qui implémente l'interface `Doctrine\DBAL\Logging\SQLLoger`. 

Si nous avions déjà un système de log, nous aurions pu le configurer pour supporter *Doctrine* grâce à cette interface.
Mais pour notre cas, nous allons utiliser une classe fournie par défaut par *Doctrine*. La configuration de *Doctrine* ressemble maintenant à :

```php
<?php
# bootstrap.php

require_once join(DIRECTORY_SEPARATOR, [__DIR__, 'vendor', 'autoload.php']);

use Doctrine\ORM\Tools\Setup;
use Doctrine\ORM\EntityManager;
use Doctrine\DBAL\Logging\DebugStack;

$entitiesPath = [
    join(DIRECTORY_SEPARATOR, [__DIR__, "src", "Entity"])
];

$isDevMode = true;
$proxyDir = null;
$cache = null;
$useSimpleAnnotationReader = false;

// Connexion à la base de données
$dbParams = [
    'driver'   => 'pdo_mysql',
    'host'     => 'localhost',
    'charset'  => 'utf8',
    'user'     => 'root',
    'password' => '',
    'dbname'   => 'poll',
];

$config = Setup::createAnnotationMetadataConfiguration(
    $entitiesPath,
    $isDevMode,
    $proxyDir,
    $cache,
    $useSimpleAnnotationReader
);

// Logger fourni nativement par Doctrine
$config->setSQLLogger(new DebugStack());

$entityManager = EntityManager::create($dbParams, $config);

return $entityManager;
```

Pour tester cette modification, nous allons réutiliser la méthode de récupération des participations d'un utilisateur.

```php
<?php
# get-user-participations.php

$entityManager = require_once join(DIRECTORY_SEPARATOR, [__DIR__, 'bootstrap.php']);

use Tuto\Entity\User;

$time = microtime(true);

$userRepo = $entityManager->getRepository(User::class);
$user = $userRepo->find(3);

$participations = $user->getParticipations();

foreach ($participations as $participation) {
    echo $participation;
    $choices = $participation->getChoices();
    foreach ($choices as $choice) {
        echo "- ", $choice;
        $answers = $choice->getAnswers();
        echo "-- ", $choice->getQuestion();
        foreach ($answers as $answer) {
            echo "--- ", $answer;
        }
    }
}

$time = microtime(true) - $time;
$logger = $entityManager->getConfiguration()->getSQLLogger();

echo "\nPerformances:\n";
echo "Nombre de requêtes : ", count($logger->queries), "\n";
echo "Durée d'exécution totale : ", $time , " ms\n";

foreach ($logger->queries as $query) {
    echo "- ", json_encode($query), "\n";
}
```

Avec la réponse, nous avons en détails toutes les requêtes exécutées et leur durées :

```txt
Performances:
Nombre de requêtes : 8
Durée d'exécution totale : 0.20801091194153 ms
- {"sql":"SELECT t0.id AS id_1, t0.firstname AS firstname_2, t0.lastname AS lastname_3, t0.role AS role_4, t0.address_id AS address_id_5 FROM users t0 WHERE t0.id = ?","params":[3],"types":["integer"],"executionMS":0.031002044677734}
- {"sql":"SELECT t0.id AS id_1, t0.date AS date_2, t0.user_id AS user_id_3, t0.poll_id AS poll_id_4 FROM participations t0 WHERE t0.user_id = ?","params":[3],"types":["integer"],"executionMS":0.014001131057739}
- {"sql":"SELECT t0.id AS id_1, t0.title AS title_2, t0.created AS created_3 FROM polls t0 WHERE t0.id = ?","params":[1],"types":["integer"],"executionMS":0.01400089263916}
- {"sql":"SELECT t0.id AS id_1, t0.question_id AS question_id_2, t0.participation_id AS participation_id_3 FROM choices t0 WHERE t0.participation_id = ?","params":[1],"types":["integer"],"executionMS":0.002000093460083}
- {"sql":"SELECT t0.id AS id_1, t0.wording AS wording_2, t0.poll_id AS poll_id_3 FROM questions t0 WHERE t0.id = ?","params":[2],"types":["integer"],"executionMS":0.013000965118408}
- {"sql":"SELECT t0.id AS id_1, t0.wording AS wording_2, t0.question_id AS question_id_3 FROM answers t0 INNER JOIN selected_answers ON t0.id = selected_answers.answer_id WHERE selected_answers.choice_id = ?","params":[1],"types":["integer"],"executionMS":0.015000104904175}
- {"sql":"SELECT t0.id AS id_1, t0.wording AS wording_2, t0.poll_id AS poll_id_3 FROM questions t0 WHERE t0.id = ?","params":[3],"types":["integer"],"executionMS":0}
- {"sql":"SELECT t0.id AS id_1, t0.wording AS wording_2, t0.question_id AS question_id_3 FROM answers t0 INNER JOIN selected_answers ON t0.id = selected_answers.answer_id WHERE selected_answers.choice_id = ?","params":[2],"types":["integer"],"executionMS":0}
[Finished in 0.4s]
```

Nous sommes actuellement à huit (8) requêtes. Voyons donc comment faire pour réduire ce nombre.